<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Mini Empire: Defenders</title>
  <link rel="icon" href="../../icon.jpg" type="image/x-icon">
  <style>
    body {
      background: radial-gradient(circle at top, #1a1a1a, #0c0c0c);
      color: #eee;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-top: 20px;
      letter-spacing: 2px;
    }

    /* ==== GRID ==== */
    #game {
      display: grid;
      grid-template-columns: repeat(10, 45px);
      grid-template-rows: repeat(10, 45px);
      gap: 3px;
      margin-top: 20px;
    }

    .tile {
      width: 45px;
      height: 45px;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .tile:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px #aaa;
    }

    .grass {
      background: #357a38;
    }

    .forest {
      background: #2b542c;
    }

    .mountain {
      background: #555;
    }

    .water {
      background: #003366;
    }

    .farm {
      background: #e3a93b;
    }

    .house {
      background: #4d7cff;
    }

    .mine {
      background: #8e8e8e;
    }

    .market {
      background: #c2462f;
    }

    .fort {
      background: #6666aa;
    }

    .enemy {
      background: #9b1d1d;
    }

    /* ==== INFO ==== */
    #info {
      margin-top: 15px;
      text-align: center;
    }

    button {
      margin: 4px;
      padding: 6px 12px;
      background: #555;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #777;
    }

    button:disabled {
      background: #333;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #alert {
      margin-top: 10px;
      color: #f44;
      font-weight: bold;
    }

    /* ==== TECH TREE ==== */
    #techTree {
      margin-top: 15px;
      border: 1px solid #444;
      padding: 10px;
      width: 340px;
      text-align: left;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    #techTree h3 {
      margin: 5px 0;
    }

    #techTree p {
      margin: 4px 0;
      font-size: 14px;
    }

    /* ==== TUTORIAL ==== */
    #tutorial {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 10, 0.92);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      font-size: 16px;
      padding: 20px;
    }

    #tutorial button {
      margin-top: 20px;
      background: #4caf50;
    }
  </style>
</head>

<body>

  <h1>Mini Empire ğŸ°</h1>

  <div id="info">
    <div>
      ğŸ Food: <span id="food">10</span> |
      ğŸ’° Money: <span id="money">10</span> |
      ğŸ‘¥ Population: <span id="pop">0</span> |
      ğŸ… Level: <span id="levelNum">1</span> |
      ğŸ›¡ Defense: <span id="defense">0</span>
    </div>
    <div>
      <button id="buildFarm">Farm (ğŸ’°5)</button>
      <button id="buildHouse">House (-5ğŸ)</button>
      <button id="buildMine" disabled>Mine (ğŸ’°8)</button>
      <button id="buildMarket" disabled>Market (ğŸ’°15)</button>
      <button id="buildFort" disabled>Fort (ğŸ’°20)</button>
    </div>
    <div id="alert"></div>
  </div>

  <div id="game"></div>

  <div id="techTree">
    <h3>ğŸ”¬ Tech Tree</h3>
    <p id="techFarm">âœ” Farms: unlocked</p>
    <p id="techMine">âŒ Unlock Mines (ğŸ’°50)</p>
    <p id="techMarket">âŒ Unlock Markets (ğŸ’°150)</p>
    <p id="techFort">âŒ Unlock Forts (ğŸ’°250)</p>
    <p id="techVictory">âŒ Reach ğŸ’°600 to win!</p>
  </div>

  <div id="tutorial">
    <h2>Welcome to Mini Empire: Defenders</h2>
    <p>
      Build your empire ğŸŒ† and defend it from enemy raids!<br><br>
      ğŸŒ¾ Farm = +Food<br>
      ğŸ  House = +Population<br>
      â› Mine = +Money<br>
      ğŸ¬ Market = Boost income<br>
      ğŸ›¡ Fort = Adds defense, protects from enemies<br><br>
      Beware of ğŸ‰ enemy attacks every few turns!<br>
      Earn ğŸ’° to unlock more buildings.
    </p>
    <button id="startGame">Start Game</button>
  </div>

  <script>
    const game = document.getElementById("game");
    const foodDisplay = document.getElementById("food");
    const moneyDisplay = document.getElementById("money");
    const popDisplay = document.getElementById("pop");
    const levelDisplay = document.getElementById("levelNum");
    const defenseDisplay = document.getElementById("defense");
    const alertBox = document.getElementById("alert");

    const buildFarmBtn = document.getElementById("buildFarm");
    const buildHouseBtn = document.getElementById("buildHouse");
    const buildMineBtn = document.getElementById("buildMine");
    const buildMarketBtn = document.getElementById("buildMarket");
    const buildFortBtn = document.getElementById("buildFort");

    const techMine = document.getElementById("techMine");
    const techMarket = document.getElementById("techMarket");
    const techFort = document.getElementById("techFort");
    const techVictory = document.getElementById("techVictory");

    const tutorial = document.getElementById("tutorial");
    const startBtn = document.getElementById("startGame");

    let mode = "none", food = 10, money = 10, pop = 0, level = 1, defense = 0, running = false, turn = 0;
    const MINI_SAVE_KEY = 'mini_empire_save';
    function saveMiniState() {
      try {
        const snap = {
          running: running,
          turn: turn,
          money: money,
          food: food,
          pop: pop,
          level: level,
          defense: defense,
          grid: Array.from(document.querySelectorAll('.tile')).map(t => ({ terrain: t.dataset.terrain, built: t.dataset.built || null }))
        };
        localStorage.setItem(MINI_SAVE_KEY, JSON.stringify(snap));
        // show subtle UI save notice
        alertBox.textContent = 'ğŸ’¾ Game saved';
        setTimeout(() => { if (alertBox) alertBox.textContent = ''; }, 1200);
      } catch (e) {
        console.warn('Save failed', e);
      }
    }
    function loadMiniState() {
      try {
        const s = localStorage.getItem(MINI_SAVE_KEY);
        if (!s) return false;
        const obj = JSON.parse(s);
        running = !!obj.running;
        turn = obj.turn || 0;
        money = obj.money || 0;
        food = obj.food || 0;
        pop = obj.pop || 0;
        level = obj.level || 1;
        defense = obj.defense || 0;
        // restore tiles
        const tiles = document.querySelectorAll('.tile');
        if (tiles && tiles.length && obj.grid) {
          tiles.forEach((t, i) => {
            const g = obj.grid[i];
            if (!g) return;
            delete t.dataset.built;
            t.className = `tile ${g.terrain}`;
            t.dataset.terrain = g.terrain;
            t.textContent = getTerrainEmoji(g.terrain);
            if (g.built) {
              t.dataset.built = g.built;
              t.classList.add(g.built);
              if (g.built === 'fort') t.textContent = 'ğŸ›¡';
              else if (g.built === 'farm') t.textContent = 'ğŸŒ¾';
              else if (g.built === 'house') t.textContent = 'ğŸ ';
              else if (g.built === 'mine') t.textContent = 'â›ï¸';
              else if (g.built === 'market') t.textContent = 'ğŸ¬';
            }
          });
        }
        alertBox.textContent = 'âš¡ Autosave loaded';
        setTimeout(() => { if (alertBox) alertBox.textContent = ''; }, 1200);
        updateStats();
        return true;
      } catch (e) { console.warn('Load failed', e); return false; }
    }

    if (loadMiniState()) {
      // subtle indicator only
      console.log('Autosave restored.');
    }
    setInterval(() => { if (running) saveMiniState(); }, 5000);


    const terrains = [
      "plains", "plains", "plains", "plains", "plains",
      "forest", "forest",
      "rock", "mountain",
      "water"
    ];


    for (let i = 0; i < 100; i++) {
      const t = document.createElement("div");
      const terrain = terrains[Math.floor(Math.random() * terrains.length)];
      t.classList.add("tile", terrain);
      t.dataset.terrain = terrain;
      t.textContent = getTerrainEmoji(terrain);
      t.addEventListener("click", () => build(t));
      game.appendChild(t);
    }

    function getTerrainEmoji(terrain) {
      switch (terrain) {
        case "rock": return "ğŸª¨";
        case "mountain": return "â›°ï¸";
        case "water": return "ğŸŒŠ";
        default: return "ğŸŒ±";
      }
    }


    buildFarmBtn.onclick = () => mode = "farm";
    buildHouseBtn.onclick = () => mode = "house";
    buildMineBtn.onclick = () => mode = "mine";
    buildMarketBtn.onclick = () => mode = "market";
    buildFortBtn.onclick = () => mode = "fort";


    function build(tile) {
      if (!running || tile.classList.contains("enemy")) return;
      const terrain = tile.dataset.terrain;
      if (tile.dataset.built) return;
      switch (mode) {
        case "farm":
          if (terrain === "water" || terrain === "mountain") return;
          if (money >= 5) { money -= 5; tile.dataset.built = "farm"; tile.textContent = "ğŸŒ¾"; tile.className = "tile farm"; }
          break;
        case "house":
          if (food >= 5) { food -= 5; pop += 2; tile.dataset.built = "house"; tile.textContent = "ğŸ "; tile.className = "tile house"; }
          break;
        case "mine":
          if (level >= 2 && money >= 8 && terrain === "mountain") { money -= 8; tile.dataset.built = "mine"; tile.textContent = "â›ï¸"; tile.className = "tile mine"; }
          break;
        case "market":
          if (level >= 3 && money >= 15) { money -= 15; tile.dataset.built = "market"; tile.textContent = "ğŸ¬"; tile.className = "tile market"; }
          break;
        case "fort":
          if (level >= 4 && money >= 20) { money -= 20; defense += 5; tile.dataset.built = "fort"; tile.textContent = "ğŸ›¡"; tile.className = "tile fort"; }
          break;
      }


      if (window.badgeSystem) {
        const farmCount = document.querySelectorAll(".farm").length;
        const houseCount = document.querySelectorAll(".house").length;

        if (mode === "farm" && !window.badgeSystem.isBadgeUnlocked('city-start')) {
          window.badgeSystem.unlockBadge('city-start');
        }
      }

      updateStats();
    }


    function gameLoop() {
      if (!running) return;
      turn++;

      const farms = document.querySelectorAll(".farm").length;
      const houses = document.querySelectorAll(".house").length;
      const mines = document.querySelectorAll(".mine").length;
      const markets = document.querySelectorAll(".market").length;
      const forts = document.querySelectorAll(".fort").length;

      const boost = 1 + markets * 0.1;
      food += (farms * 2 - pop * 0.4) * boost;
      money += (houses * 1 + mines * 3) * boost;

      if (food > pop * 2) pop += 0.1;


      if (money >= 50 && level < 2) unlockTech(2, "Mines unlocked!", buildMineBtn, techMine);
      if (money >= 150 && level < 3) unlockTech(3, "Markets unlocked!", buildMarketBtn, techMarket);
      if (money >= 250 && level < 4) unlockTech(4, "Forts unlocked!", buildFortBtn, techFort);
      if (money >= 600) { running = false; alertBox.textContent = "ğŸ† Victory! Your empire dominates!"; techVictory.textContent = "âœ” Victory achieved!"; }


      if (turn % 8 === 0 && running) enemyRaid();

      if (food <= 0) { running = false; food = 0; alertBox.textContent = "â˜  Your people starved! Game Over."; }
      updateStats();
    }


    function enemyRaid() {
      alertBox.textContent = "âš”ï¸ Enemies are attacking!";
      const enemyTiles = [...document.querySelectorAll(".tile")].filter(t => !t.dataset.built && t.dataset.terrain !== "water");
      if (enemyTiles.length === 0) return;
      const target = enemyTiles[Math.floor(Math.random() * enemyTiles.length)];
      target.className = "tile enemy";
      target.textContent = "ğŸ’€";
      setTimeout(() => resolveRaid(target), 2000);
    }

    function resolveRaid(tile) {
      const alertEl = alertBox;
      const enemyStrength = Math.floor(Math.random() * 6) + 1; // 1..6
      if (defense >= enemyStrength) {
        alertEl.textContent = "ğŸ›¡ï¸ Forts repelled the enemy!";
        defense = Math.max(0, defense - Math.floor(enemyStrength / 2));
      } else {
        alertEl.textContent = "ğŸ’¥ The raid damaged your lands!";
        const builtTiles = [...document.querySelectorAll('.tile')].filter(t => t.dataset.built);
        if (builtTiles.length > 0) {
          const victim = builtTiles[Math.floor(Math.random() * builtTiles.length)];
          delete victim.dataset.built;
          victim.className = `tile ${victim.dataset.terrain}`;
          victim.textContent = victim.dataset.terrain === 'water' ? 'ğŸŒŠ' : getTerrainEmoji(victim.dataset.terrain);
        }
        pop = Math.max(0, pop - Math.floor(Math.random() * 5));
        food = Math.max(0, food - Math.floor(Math.random() * 10));
        // reputation optional: keep if exists
        if (typeof reputation !== 'undefined') reputation = Math.max(0, reputation - 5);
      }
      updateStats();
      setTimeout(() => { if (alertEl) alertEl.textContent = ''; }, 3000);
    }


    function unlockTech(lvl, msg, btn, txt) {
      level = lvl;
      btn.disabled = false;
      txt.textContent = txt.textContent.replace("âŒ", "âœ”");
      alertBox.textContent = msg;
      setTimeout(() => { alertBox.textContent = ''; }, 2000);
    }


    function updateStats() {
      foodDisplay.textContent = Math.floor(food);
      moneyDisplay.textContent = Math.floor(money);
      popDisplay.textContent = Math.floor(pop);
      levelDisplay.textContent = level;
      defenseDisplay.textContent = defense;
    }


    // ensure single game loop interval and start handler
    let gameLoopInterval = null;
    startBtn.onclick = () => {
      tutorial.style.display = "none";
      if (!running) {
        running = true;
        if (!gameLoopInterval) gameLoopInterval = setInterval(gameLoop, 1500);
        startBtn.disabled = true;
      }
    };

    document.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'p') { saveMiniState(); alert('Game saved'); } });
  </script>
</body>

</html>