<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Empire BETA</title>
  <link rel="icon" href="../../icon.jpg" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    #container {
      position: relative;
      width: 800px;
      height: 600px;
    }

    canvas {
      background: linear-gradient(180deg, #222, #111);
      border: 3px solid #666;
      box-shadow: 0 0 20px #000;
    }

    #fade {
      position: absolute;
      top: 0;
      left: 0;
      width: 800px;
      height: 600px;
      background: #000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s;
    }
  </style>
</head>

<body>
  <div id="container">
    <canvas id="game" width="800" height="600"></canvas>
    <div id="fade"></div>
  </div>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const fade = document.getElementById("fade");

    let scene = "world";
    let transitioning = false;
    let currentRegion = "Siege Lands";
    let hoverArea = null, currentEnemy = null;
    let flash = 0, shake = 0, goldAnim = [];


    const player = {
      hp: 100,
      maxHp: 100,
      attack: 10,
      defense: 5,
      gold: 0,
      level: 1,
      exp: 0,
      expNeeded: 100,
      equipment: {
        weapon: { name: "Basic Sword", atk: 2 },
        armor: { name: "Leather Armor", def: 1 }
      }
    };
    const EMPIRE_SAVE_KEY = 'empire_save_v1';

    try {
      const s = localStorage.getItem(EMPIRE_SAVE_KEY);
      if (s) {
        const p = JSON.parse(s);
        Object.assign(player, p);
      }
    } catch (e) { console.warn('empire load failed', e); }


    const regions = {
      "Siege Lands": [
        { name: "Siege Camp", hp: 60, atk: 5, def: 2, loot: 10, req: {} },
        { name: "Siege Camp 2", hp: 110, atk: 10, def: 5, loot: 20, req: { atk: 15, def: 8 } },
        { name: "BOSS", hp: 180, atk: 16, def: 8, loot: 35, req: { atk: 25, def: 15 } },
      ],
      "North Island": [
        { name: "Ice Kingdom", hp: 220, atk: 18, def: 12, loot: 45, req: { atk: 30, def: 18 } },
        { name: "BOSS", hp: 300, atk: 22, def: 15, loot: 55, req: { atk: 35, def: 20 } },
      ],
      "Volcanic Valley": [
        { name: "Ash Camp", hp: 360, atk: 25, def: 20, loot: 70, req: { atk: 45, def: 25 } },
        { name: "BOSS", hp: 500, atk: 35, def: 20, loot: 90, req: { atk: 50, def: 28 } },
      ]
    };


    const regionUnlocks = {
      "North Island": { atk: 25, def: 15 },
      "Volcanic Valley": { atk: 40, def: 22 },
    };


    const shopItems = {
      weapons: [
        { name: "+5 Attack", atk: 5, cost: 50 },
        { name: "+11 Attack", atk: 11, cost: 90 },
        { name: "+17 Attack", atk: 17, cost: 140 }
      ],
      armor: [
        { name: "+3 Defense", def: 3, cost: 50 },
        { name: "+7 Defense", def: 7, cost: 100 },
        { name: "+12 Defense", def: 12, cost: 150 }
      ],
    };


    function getPlayerTotalAttack() { return player.attack + (player.equipment.weapon && player.equipment.weapon.atk ? player.equipment.weapon.atk : 0); }
    function getPlayerTotalDefense() { return player.defense + (player.equipment.armor && player.equipment.armor.def ? player.equipment.armor.def : 0); }

    function checkAreaUnlocked(area) {
      if (!area.req) return true;
      const { atk = 0, def = 0 } = area.req;
      return getPlayerTotalAttack() >= atk && getPlayerTotalDefense() >= def;
    }
    function checkRegionUnlocked(name) {
      if (name === "Siege Lands") return true;
      const req = regionUnlocks[name];
      return req && getPlayerTotalAttack() >= req.atk && getPlayerTotalDefense() >= req.def;
    }


    function drawWorld() {
      ctx.clearRect(0, 0, 800, 600);
      const grad = ctx.createLinearGradient(0, 0, 0, 600);
      grad.addColorStop(0, "#111"); grad.addColorStop(1, "#000");
      ctx.fillStyle = grad; ctx.fillRect(0, 0, 800, 600);

      ctx.fillStyle = "#fff";
      ctx.font = "28px DM Sans";
      ctx.fillText("World Map", 320, 60);

      const worldRegions = Object.keys(regions);
      worldRegions.forEach((r, i) => {
        const unlocked = checkRegionUnlocked(r);
        const x = 150 + (i * 250), y = 250;
        ctx.globalAlpha = unlocked ? 1 : 0.3;
        ctx.fillStyle = (hoverArea === r) ? "#666" : "#333";
        ctx.fillRect(x, y, 180, 80);
        ctx.strokeStyle = unlocked ? "#ff0" : "#666";
        ctx.strokeRect(x, y, 180, 80);
        ctx.fillStyle = "#fff";
        ctx.font = "18px DM Sans";
        ctx.fillText(r, x + 20, y + 45);
      });
      ctx.globalAlpha = 1;
    }


    function drawRegion() {
      ctx.clearRect(0, 0, 800, 600);
      const grd = ctx.createLinearGradient(0, 0, 0, 600);
      grd.addColorStop(0, "#1a1a1a"); grd.addColorStop(1, "#090909");
      ctx.fillStyle = grd; ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = "#fff";
      ctx.font = "22px DM Sans";
      ctx.fillText(currentRegion, 320, 50);

      const areas = regions[currentRegion];
      areas.forEach((a, i) => {
        const unlocked = checkAreaUnlocked(a);
        const x = 150 + i * 200, y = 250;
        ctx.globalAlpha = unlocked ? 1 : 0.4;
        const hover = (hoverArea === a);
        const scale = hover ? 1.1 : 1;
        const w = 150 * scale, h = 80 * scale;
        const gx = x - (w - 150) / 2, gy = y - (h - 80) / 2;
        ctx.fillStyle = (hover) ? "#555" : "#333";
        ctx.fillRect(gx, gy, w, h);
        ctx.strokeStyle = hover ? "#ff0" : "#666";
        ctx.strokeRect(gx, gy, w, h);
        ctx.fillStyle = "#fff";
        ctx.font = "16px DM Sans";
        ctx.fillText(a.name, gx + 10, gy + 45);
      });
      ctx.globalAlpha = 1;


      drawButton(30, 30, 100, 40, "Back");
      drawButton(670, 30, 100, 40, "Shop");
    }


    function drawBattle() {
      ctx.clearRect(0, 0, 800, 600);
      const bg = ctx.createLinearGradient(0, 0, 0, 600);
      bg.addColorStop(0, "#3a0000"); bg.addColorStop(1, "#1a0000");
      ctx.fillStyle = bg; ctx.fillRect(0, 0, 800, 600);

      ctx.save();
      if (shake) ctx.translate(Math.random() * shake - shake / 2, Math.random() * shake - shake / 2);
      ctx.fillStyle = "#fff";
      ctx.font = "22px DM Sans";
      ctx.fillText(currentEnemy.name, 520, 60);
      ctx.fillStyle = "#900";
      ctx.fillRect(520, 80, 200 * (currentEnemy.hp / currentEnemy.maxHp), 20);
      ctx.strokeStyle = "#fff"; ctx.strokeRect(520, 80, 200, 20);

      ctx.fillStyle = "#0f0";
      ctx.fillRect(80, 80, 200 * (player.hp / player.maxHp), 20);
      ctx.strokeStyle = "#fff"; ctx.strokeRect(80, 80, 200, 20);
      ctx.fillStyle = "#fff"; ctx.fillText("You", 150, 60);


      ctx.fillStyle = "#55f";
      ctx.fillRect(80, 110, 200 * (player.exp / player.expNeeded), 10);
      ctx.strokeStyle = "#88f"; ctx.strokeRect(80, 110, 200, 10);
      ctx.fillStyle = "#fff";
      ctx.font = "14px DM Sans";
      ctx.fillText(`Level ${player.level}`, 80, 140);

      drawButton(350, 500, 120, 45, "Attack");

      if (flash > 0) { ctx.fillStyle = `rgba(255,255,255,${flash / 10})`; ctx.fillRect(0, 0, 800, 600); flash--; }
      ctx.restore();

      goldAnim.forEach(g => {
        ctx.globalAlpha = g.alpha;
        ctx.fillStyle = "gold"; ctx.font = "18px DM Sans";
        ctx.fillText(`+${g.amount}`, g.x, g.y);
        g.y -= 1; g.alpha -= 0.02;
      });
      ctx.globalAlpha = 1;
      goldAnim = goldAnim.filter(g => g.alpha > 0);
    }


    function drawButton(x, y, w, h, label) {
      ctx.fillStyle = "#333"; ctx.fillRect(x, y, w, h);
      ctx.strokeStyle = "#777"; ctx.strokeRect(x, y, w, h);
      ctx.fillStyle = "#fff"; ctx.font = "18px DM Sans";
      ctx.fillText(label, x + 15, y + 26);
    }


    function fadeTo(target) {
      transitioning = true; fade.style.opacity = 1;
      setTimeout(() => { scene = target; fade.style.opacity = 0; transitioning = false; }, 600);
    }


    const shopList = [
      ...shopItems.weapons.map(i => ({ ...i, type: 'weapon' })),
      ...shopItems.armor.map(i => ({ ...i, type: 'armor' }))
    ];


    function drawShop() {
      ctx.clearRect(0, 0, 800, 600);
      const bg = ctx.createLinearGradient(0, 0, 0, 600);
      bg.addColorStop(0, "#1a1a2a"); bg.addColorStop(1, "#0a0a1a");
      ctx.fillStyle = bg; ctx.fillRect(0, 0, 800, 600);

      ctx.fillStyle = "#fff";
      ctx.font = "24px DM Sans";
      ctx.fillText("Shop", 360, 50);
      ctx.fillText(`${player.gold}`, 650, 50);


      let y = 120;
      shopList.forEach((item, i) => {
        const x = 150;
        ctx.fillStyle = player.gold >= item.cost ? "#444" : "#333";
        ctx.fillRect(x, y, 500, 60);
        ctx.strokeStyle = "#666";
        ctx.strokeRect(x, y, 500, 60);

        ctx.fillStyle = "#fff";
        ctx.font = "18px DM Sans";
        ctx.fillText(item.name, x + 20, y + 35);
        ctx.fillText(`Cost: ${item.cost}`, x + 300, y + 35);
        ctx.fillText(item.atk ? `ATK +${item.atk}` : `DEF +${item.def}`, x + 420, y + 35);
        y += 70;
      });

      ctx.fillStyle = "#fff";
      ctx.font = "18px DM Sans";
      drawButton(30, 30, 100, 40, "Back");
    }


    function gainExp(amount) {
      player.exp += amount;
      while (player.exp >= player.expNeeded) {
        player.level++;
        player.exp -= player.expNeeded;
        player.expNeeded = Math.floor(player.expNeeded * 1.5);
        player.maxHp += 20;
        player.hp = player.maxHp;
        player.attack += 2;
        player.defense += 1;
        alert(`Level Up! Now level ${player.level}`);
      }
    }


    function battleTurn() {
      const dmgToEnemy = Math.max(1, player.attack + player.equipment.weapon.atk - currentEnemy.def);
      currentEnemy.hp = Math.max(0, currentEnemy.hp - dmgToEnemy);
      flash = 5; shake = 4;
      if (currentEnemy.hp <= 0) {
        goldAnim.push({ x: 400, y: 300, amount: currentEnemy.loot, alpha: 1 });
        player.gold += currentEnemy.loot;

        try { localStorage.setItem(EMPIRE_SAVE_KEY, JSON.stringify(player)); } catch (e) { }
        gainExp(currentEnemy.loot * 2);
        player.hp = player.maxHp;
        setTimeout(() => fadeTo("region"), 700);
        return;
      }
      setTimeout(() => {
        const dmgToPlayer = Math.max(1, currentEnemy.atk - player.defense);
        player.hp = Math.max(0, player.hp - dmgToPlayer);
        flash = 5; shake = 4;
        if (player.hp <= 0) {
          alert("Defeated! Resting...");
          player.hp = player.maxHp;
          fadeTo("region");
        }
      }, 400);
    }


    canvas.addEventListener("mousemove", e => {
      if (transitioning) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      hoverArea = null;

      if (scene === "world") {
        for (let r of Object.keys(regions)) {
          const i = Object.keys(regions).indexOf(r);
          const x = 150 + (i * 250), y = 250;
          if (mx > x && mx < x + 180 && my > y && my < y + 80 && checkRegionUnlocked(r)) hoverArea = r;
        }
      }
      else if (scene === "region") {
        const areas = regions[currentRegion];
        for (let a of areas) {
          const i = areas.indexOf(a);
          const x = 150 + i * 200, y = 250;
          if (mx > x && mx < x + 150 && my > y && my < y + 80 && checkAreaUnlocked(a)) hoverArea = a;
        }
      }
    });

    canvas.addEventListener("click", e => {
      if (transitioning) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;

      if (scene === "world" && hoverArea) {
        currentRegion = hoverArea;
        fadeTo("region");
      }
      else if (scene === "region") {
        const areas = regions[currentRegion];
        if (mx > 30 && mx < 130 && my > 30 && my < 70) { fadeTo("world"); return; }
        if (mx > 670 && mx < 770 && my > 30 && my < 70) { fadeTo("shop"); return; }
        if (hoverArea) {
          currentEnemy = { ...hoverArea, maxHp: hoverArea.hp };
          fadeTo("battle");
        }
      }
      else if (scene === "battle") {
        if (mx > 350 && mx < 470 && my > 500 && my < 545) battleTurn();
      }
      else if (scene === "shop") {
        if (mx > 30 && mx < 130 && my > 30 && my < 70) { fadeTo("region"); return; }
        let y = 120;
        shopList.forEach((item, i) => {
          if (mx > 150 && mx < 650 && my > y && my < y + 60) {
            if (player.gold >= item.cost) {
              player.gold -= item.cost;
              if (item.type === 'weapon') player.equipment.weapon = item;
              else player.equipment.armor = item;

              try { localStorage.setItem(EMPIRE_SAVE_KEY, JSON.stringify(player)); } catch (e) { }
            }
          }
          y += 70;
        });
      }
    });


    function loop() {
      if (scene === "world") drawWorld();
      else if (scene === "region") drawRegion();
      else if (scene === "battle") drawBattle();
      else if (scene === "shop") drawShop();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>

</html>