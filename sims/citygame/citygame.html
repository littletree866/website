<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metropolis Builder</title>
  <link rel="icon" href="../../icon.jpg" type="image/x-icon">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Ink Free', cursive
    }

    :root {
      --bg1: #0f1724;
      --bg2: #12213b;
      --panel: rgba(255, 255, 255, 0.04);
      --accent: #1e90ff;
      --good: #4caf50;
      --bad: #ff6b6b;
      --glass: rgba(255, 255, 255, 0.04);
    }

    html,
    body {
      height: 100%
    }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: #e6eef8;
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .wrap {
      width: 1200px;
      max-width: 96%;
      display: flex;
      flex-direction: column;
      gap: 18px
    }

    header {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      padding: 14px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
    }

    header h1 {
      font-size: 20px;
      letter-spacing: 0.4px
    }

    header .meta {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 14px;
      color: #cfe8ff
    }

    .main {
      display: flex;
      gap: 18px;
    }

    .city-panel {
      background: var(--panel);
      padding: 12px;
      border-radius: 12px;
      flex: 1;
      min-width: 520px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .city-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px
    }

    .resources {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .resource {
      background: rgba(255, 255, 255, 0.02);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 14px;
      display: flex;
      gap: 8px;
      align-items: center
    }

    #cityGrid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
      background: linear-gradient(180deg, #234, #123);
      padding: 10px;
      border-radius: 8px;
      aspect-ratio: 1/1;
      box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .cell {
      background: linear-gradient(180deg, #cfe8ff10, #00000008);
      border-radius: 6px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      user-select: none;
      font-size: 18px;
      padding: 4px;
      transition: transform .15s, box-shadow .15s;
    }

    .cell:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45)
    }

    .cell.empty {
      background: linear-gradient(180deg, #cfe8ff06, #00000004)
    }

    .cell.residential {
      background: linear-gradient(180deg, #ffb6c166, #ff8ba044)
    }

    .cell.commercial {
      background: linear-gradient(180deg, #ffd70066, #ffaa0044)
    }

    .cell.industrial {
      background: linear-gradient(180deg, #c0c0c066, #a0a0a044)
    }

    .cell.park {
      background: linear-gradient(180deg, #90ee9066, #32cd3244)
    }

    .cell.road {
      background: linear-gradient(180deg, #555, #333)
    }

    .cell.water {
      background: linear-gradient(180deg, #1e90ff66, #00bfff44);
    }

    .cell .symbol {
      font-size: 20px;
      pointer-events: none
    }

    .cell .level-badge {
      position: absolute;
      bottom: 4px;
      left: 6px;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35)
    }

    .cell .indicators {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 12px
    }

    .cell.can-upgrade::after {
      content: "‚¨ÜÔ∏è";
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 12px
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) scale(.98);
      background: rgba(0, 0, 0, 0.85);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s, transform .15s;
      z-index: 50;
      color: #e6f3ff
    }

    .cell:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) scale(1)
    }

    .controls {
      width: 360px;
      min-width: 280px;
      background: var(--panel);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .tabs {
      display: flex;
      gap: 6px
    }

    .tab {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
      text-align: center;
      cursor: pointer
    }

    .tab.active {
      background: linear-gradient(90deg, var(--accent), #60a6ff);
      color: #061226;
      font-weight: 700
    }

    .buildings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px
    }

    .building-option {
      background: rgba(255, 255, 255, 0.02);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform .12s, box-shadow .12s
    }

    .building-option.selected {
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(30, 144, 255, 0.12);
      transform: translateY(-3px)
    }

    .building-option .cost {
      font-size: 13px;
      opacity: .9;
      margin-top: 6px
    }

    .upgrades-grid {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .upgrade-option {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
      cursor: pointer
    }

    .upgrade-option.disabled {
      opacity: .45;
      cursor: not-allowed
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 8px;
      text-align: center
    }

    .time-controls {
      display: flex;
      gap: 8px
    }

    .time-btn {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      background: var(--accent);
      color: #051025;
      border: none;
      cursor: pointer
    }

    .message {
      position: fixed;
      right: 20px;
      top: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transform: translateX(20px);
      transition: opacity .2s, transform .2s;
      z-index: 999
    }

    .message.show {
      opacity: 1;
      transform: translateX(0)
    }

    footer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      color: #cfe8ff;
      opacity: .9;
      font-size: 13px
    }

    @media(max-width:900px) {
      .main {
        flex-direction: column
      }

      .controls {
        order: 2
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Metropolis Builder</h1>
      <div class="meta">Tip: left-click to build ¬∑ right-click to upgrade ¬∑ D = Destroy</div>
    </header>

    <div class="main">
      <section class="city-panel">
        <div class="city-top">
          <div><strong>Your City</strong></div>
          <div class="resources">
            <div class="resource">üí∞ <span id="money">$0</span></div>
            <div class="resource">üë• <span id="population">0</span></div>
            <div class="resource">‚ö° <span id="energy">0</span></div>
          </div>
        </div>

        <div id="cityGrid" aria-label="City grid"></div>

        <div class="time-controls" style="margin-top:10px">
          <button class="time-btn" id="pauseBtn">‚è∏ Pause</button>
          <button class="time-btn" id="normalBtn">‚ñ∂ Normal</button>
          <button class="time-btn" id="fastBtn">‚è© Fast</button>
        </div>
      </section>

      <aside class="controls">
        <div class="tabs">
          <div class="tab active" data-tab="build">Build</div>
          <div class="tab" data-tab="upgrades">Upgrades</div>
          <div class="tab" data-tab="manage">Manage</div>
        </div>

        <div id="buildTab" class="tab-content">
          <h3 style="margin-bottom:8px">Buildings</h3>
          <div class="buildings-grid" id="buildingsGrid"></div>

          <div style="margin-top:8px">
            <div class="building-option" id="destroyOption" data-type="destroy">
              <div>üóëÔ∏è Destroy (50% refund)</div>
              <div class="cost">Hold/Click to remove a building</div>
            </div>
          </div>
        </div>

        <div id="upgradesTab" class="tab-content" style="display:none">
          <h3 style="margin-bottom:8px">Upgrades</h3>
          <div class="upgrades-grid" id="upgradesGrid"></div>
        </div>

        <div id="manageTab" class="tab-content" style="display:none">
          <h3 style="margin-bottom:8px">City Stats</h3>
          <div class="stats">
            <div class="stat-card">Residential<br><strong id="residentialCount">0</strong></div>
            <div class="stat-card">Commercial<br><strong id="commercialCount">0</strong></div>
            <div class="stat-card">Industrial<br><strong id="industrialCount">0</strong></div>
            <div class="stat-card">Income / cycle<br><strong id="incomeDisplay">$0</strong></div>
          </div>
        </div>
      </aside>
    </div>

    <div style="background:var(--panel);padding:12px;border-radius:12px">
      <strong>Challenges & Achievements</strong>
      <div style="display:flex;gap:10px;margin-top:8px">
        <div style="flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px">Build 5 Residential ‚Äî <span
            id="c1">0/5</span></div>
        <div style="flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px">Reach 100 Population ‚Äî <span
            id="c2">0/100</span></div>
        <div style="flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px">Earn $1000 in one cycle ‚Äî
          <span id="c3">0/1000</span>
        </div>
      </div>
    </div>

    <footer>
      <div>Remake: cleaned logic, balanced cycles, better UX</div>
      <div>Keyboard: B to cycle buildings ¬∑ D = destroy ¬∑ Space = pause</div>
    </footer>
  </div>

  <div id="message" class="message"></div>

  <script>

    const CITY_SAVE_KEY = 'city_save_v1';
    const buildingData = {
      residential: {
        cost: 100, population: 10, income: 5, energy: -2, symbol: 'üè†',
        description: 'Houses citizens', maxLevel: 3, upgradeCost: 200, happiness: 5, environmental: -2,
        levelModifiers: { population: 1.5, income: 1.3 }
      },
      commercial: {
        cost: 150, population: 0, income: 15, energy: -5, symbol: 'üè™',
        description: 'Generates income', maxLevel: 3, upgradeCost: 300, happiness: 3, environmental: -3,
        levelModifiers: { income: 1.5 }
      },
      industrial: {
        cost: 200, population: 0, income: 25, energy: -10, symbol: 'üè≠',
        description: 'High income, high energy', maxLevel: 3, upgradeCost: 400, happiness: -2, environmental: -5,
        levelModifiers: { income: 1.8, energy: 1.3 }
      },
      road: { cost: 50, population: 0, income: 0, energy: 0, symbol: 'üõ£Ô∏è', description: 'Connects city', maxLevel: 1 },
      park: { cost: 80, population: 5, income: 2, energy: -1, symbol: 'üå≥', description: 'Increases happiness', maxLevel: 2, upgradeCost: 150, happiness: 8, environmental: 10 },
      'power-plant': { cost: 300, population: 0, income: 0, energy: 30, symbol: '‚ö°', description: 'Generates energy', maxLevel: 2, upgradeCost: 500, happiness: -3, environmental: -8 }
    };

    const defaults = {
      money: 2000, population: 0, energy: 100,
      upgrades: { efficiency: false, capacity: false, renewable: false },
      gameSpeed: 1, cycleCount: 0, happiness: 50, environmental: 50
    };

    let gameState = {
      ...JSON.parse(JSON.stringify(defaults)),
      grid: [], selectedBuilding: 'residential',
      counts: { residential: 0, commercial: 0, industrial: 0, road: 0, park: 0, powerPlant: 0 },
      lastCycleIncome: 0,
      challenges: { residential5: { current: 0, target: 5 }, population100: { current: 0, target: 100 }, income1000: { current: 0, target: 1000 } }
    };


    const q = sel => document.querySelector(sel);
    const qAll = sel => Array.from(document.querySelectorAll(sel));
    const msgEl = q('#message');
    let msgTimeout = null;
    function showMessage(text, ms = 2500) {
      clearTimeout(msgTimeout);
      msgEl.textContent = text; msgEl.classList.add('show');
      msgTimeout = setTimeout(() => msgEl.classList.remove('show'), ms);
    }


    const GRID_SIZE = 10;
    function createGrid() {
      const gridEl = q('#cityGrid');
      gridEl.innerHTML = '';
      gameState.grid = [];
      for (let y = 0; y < GRID_SIZE; y++) {
        const row = [];
        for (let x = 0; x < GRID_SIZE; x++) {
          row.push({ type: 'empty', x, y, level: 1 });
          const cell = document.createElement('div');
          cell.className = 'cell empty';
          cell.dataset.x = x; cell.dataset.y = y;

          cell.addEventListener('click', (e) => onCellClick(x, y, e));
          cell.addEventListener('contextmenu', (e) => { e.preventDefault(); onCellRightClick(x, y); });
          gridEl.appendChild(cell);
        }
        gameState.grid.push(row);
      }

      gameState.grid[5][4].type = 'road';
      gameState.grid[5][5].type = 'road';
      updateGrid();
    }


    function getBuildingCfg(type) {
      return buildingData[type] || null;
    }

    function updateGrid() {

      const counts = { residential: 0, commercial: 0, industrial: 0, road: 0, park: 0, powerPlant: 0 };
      for (let y = 0; y < GRID_SIZE; y++) {
        for (let x = 0; x < GRID_SIZE; x++) {
          const cell = gameState.grid[y][x];
          const el = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
          el.className = 'cell';
          el.classList.add(cell.type === 'empty' ? 'empty' : cell.type);
          el.innerHTML = '';

          if (cell.type !== 'empty') {
            const cfg = getBuildingCfg(cell.type);
            const sym = document.createElement('div'); sym.className = 'symbol'; sym.textContent = cfg?.symbol || '‚ùì';
            const lvl = document.createElement('div'); lvl.className = 'level-badge'; lvl.textContent = `Lv ${cell.level}`;
            const inds = document.createElement('div'); inds.className = 'indicators'; inds.textContent = (cfg?.happiness > 0 ? 'üòä' : '');
            el.append(sym, lvl, inds);

            const tooltip = document.createElement('div'); tooltip.className = 'tooltip';
            const income = calculateBuildingIncome(cell);
            const energy = calculateBuildingEnergy(cell);
            tooltip.innerHTML = `<strong>${capitalize(cell.type)} (Lv ${cell.level})</strong><br>Income: ${income}<br>Energy: ${energy}`;
            el.appendChild(tooltip);

            if (cell.level < (cfg?.maxLevel || 1)) el.classList.add('can-upgrade');


            if (cell.type === 'residential') counts.residential++;
            if (cell.type === 'commercial') counts.commercial++;
            if (cell.type === 'industrial') counts.industrial++;
            if (cell.type === 'road') counts.road++;
            if (cell.type === 'park') counts.park++;
            if (cell.type === 'power-plant') counts.powerPlant++;
          }
        }
      }
      gameState.counts = counts;
      calculateStats(false);
      updateUI();
    }


    function onCellClick(x, y, event) {
      const cell = gameState.grid[y][x];
      if (gameState.selectedBuilding === 'destroy') {
        if (cell.type !== 'empty' && cell.type !== 'road') {
          const cfg = getBuildingCfg(cell.type);
          const refund = Math.floor((cfg?.cost || 0) * 0.5);

          if (cell.type === 'power-plant') {
            gameState.energy -= (cfg?.energy || 0);
          }
          cell.type = 'empty'; cell.level = 1;
          showMessage(`Destroyed building. Refund: ${refund}`);
          gameState.money += refund;
          updateGrid();
          updateChallenges();
        } else showMessage('Nothing to destroy here.');
        return;
      }

      if (cell.type !== 'empty') {
        showMessage('Cell already occupied ‚Äî right-click to upgrade.');
        return;
      }

      const cfg = getBuildingCfg(gameState.selectedBuilding);
      if (!cfg) { showMessage('Invalid building selected.'); return; }

      if (gameState.money < cfg.cost) { showMessage('Not enough money.'); return; }


      const projectedEnergy = gameState.energy + (cfg.energy || 0);
      if (gameState.selectedBuilding !== 'power-plant' && projectedEnergy < 0) {
        showMessage('Not enough energy. Build a power plant first.');
        return;
      }


      gameState.money -= cfg.cost;
      cell.type = gameState.selectedBuilding;
      cell.level = 1;

      gameState.energy += (cfg.energy || 0);
      showMessage(`Built ${gameState.selectedBuilding} for ${cfg.cost}`);
      updateGrid();
      updateChallenges();
    }

    function onCellRightClick(x, y) {
      // Simple right-click action: show upgrade info or sell
      const cell = gameState.grid && gameState.grid[y] && gameState.grid[y][x];
      if (!cell) return;
      if (cell.type && cell.type !== 'empty' && cell.level && cell.level < 3) {
        if (confirm(`Upgrade ${cell.type} for ${cell.level * 100}?`)) {
          if (gameState.money >= cell.level * 100) {
            gameState.money -= cell.level * 100;
            cell.level++;
            showMessage('Upgraded building');
            calculateStats();
            updateUI();
          } else showMessage('Not enough money');
        }
      } else showMessage('No upgrade available');
    }

    function calculateBuildingIncome(cell) {
      if (!cell || cell.type === 'empty') return 0;
      const base = { residential: 2, commercial: 6, industrial: 4 }[cell.type] || 1;
      const levelMult = (cell.level || 1) * 0.9;
      let repBonus = Math.max(0, (gameState.reputation || 50) - 50) * 0.01;
      return Math.round(base * levelMult * (1 + repBonus));
    }
    function calculateBuildingEnergy(cell) {
      if (!cell || cell.type === 'empty') return 0;
      // residential consumes, industrial produces a little
      if (cell.type === 'residential') return -1 * (cell.level || 1);
      if (cell.type === 'industrial') return 2 * (cell.level || 1);
      return 0;
    }


    function calculateStats(applyIncome = true) {
      // compute totals safely
      let income = 0, energy = 0, population = 0;
      if (!gameState.grid) gameState.grid = [];
      for (let y = 0; y < GRID_SIZE; y++) {
        for (let x = 0; x < GRID_SIZE; x++) {
          const c = gameState.grid[y][x];
          if (!c) continue;
          income += calculateBuildingIncome(c);
          energy += calculateBuildingEnergy(c);
          if (c.type === 'residential') population += (c.level || 1) * 10;
        }
      }
      gameState.lastCycleIncome = income;
      if (applyIncome) gameState.money += income;
      gameState.energy = (gameState.energy || 0) + energy;
      gameState.population = population;
      // reputation simple clamp
      gameState.reputation = Math.max(0, Math.min(100, gameState.reputation || 50));
      // UI sync
      if (document.querySelector('#incomeDisplay')) document.querySelector('#incomeDisplay').textContent = `${income}`;
      if (document.querySelector('#energyDisplay')) document.querySelector('#energyDisplay').textContent = `${gameState.energy}`;
    }

    function updateChallenges() {
      // map simple challenge progressors
      gameState.challenges = gameState.challenges || {
        residential5: { target: 5, current: 0, done: false },
        population100: { target: 100, current: 0, done: false },
        income1000: { target: 1000, current: 0, done: false }
      };
      // update counts
      const resCount = gameState.counts && gameState.counts.residential ? gameState.counts.residential : 0;
      gameState.challenges.residential5.current = resCount;
      gameState.challenges.population100.current = gameState.population || 0;
      gameState.challenges.income1000.current = Math.max(gameState.challenges.income1000.current || 0, gameState.lastCycleIncome || 0);

      // mark completions
      if (!gameState.challenges.residential5.done && gameState.challenges.residential5.current >= gameState.challenges.residential5.target) {
        gameState.challenges.residential5.done = true;
        showMessage('Challenge complete: residential5');
      }
      if (!gameState.challenges.population100.done && gameState.challenges.population100.current >= gameState.challenges.population100.target) {
        gameState.challenges.population100.done = true;
        showMessage('Challenge complete: population100');
      }
      if (!gameState.challenges.income1000.done && gameState.challenges.income1000.current >= gameState.challenges.income1000.target) {
        gameState.challenges.income1000.done = true;
        showMessage('Challenge complete: income1000');
      }

      // small UI update
      if (document.getElementById('c1')) document.getElementById('c1').textContent = `${gameState.challenges.residential5.current}/${gameState.challenges.residential5.target}`;
      if (document.getElementById('c2')) document.getElementById('c2').textContent = `${gameState.challenges.population100.current}/${gameState.challenges.population100.target}`;
      if (document.getElementById('c3')) document.getElementById('c3').textContent = `${gameState.challenges.income1000.current}/${gameState.challenges.income1000.target}`;
    }

    function triggerRandomEvent() {
      const events = [
        { msg: 'Small festival increases reputation', effect: () => { gameState.reputation = Math.min(100, (gameState.reputation || 50) + 5); }, chance: 0.02 },
        { msg: 'Power shortage reduces income this cycle', effect: () => { gameState.lastCycleIncome = Math.floor((gameState.lastCycleIncome || 0) * 0.7); }, chance: 0.01 }
      ];
      const ev = events[Math.floor(Math.random() * events.length)];
      if (ev && Math.random() < (ev.chance || 0.02)) { ev.effect(); showMessage(ev.msg); updateUI(); }
    }

    // restore grid array when loading save
    function init() {
      createGrid();
      setupUI();
      calculateStats(false); updateGrid();
      updateUI();
      startGameLoop();
      showMessage('Welcome ‚Äî left click to build, right-click to upgrade.');

      try {
        const s = localStorage.getItem(CITY_SAVE_KEY);
        if (s) {
          const obj = JSON.parse(s);

          if (typeof obj.money === 'number') gameState.money = obj.money;
          if (typeof obj.population === 'number') gameState.population = obj.population;
          if (typeof obj.energy === 'number') gameState.energy = obj.energy;
          if (Array.isArray(obj.grid) && obj.grid.length === GRID_SIZE) {
            // ensure deep structure matches internal format
            gameState.grid = obj.grid.map(row => row.map(cell => {
              // ensure expected properties
              return {
                type: cell.type || 'empty',
                level: cell.level || 0,
                ...cell
              };
            }));
          }
        }
      } catch (err) {
        console.warn('Failed to load city save:', err);
      }

      setInterval(() => {
        try {
          const snap = { money: gameState.money, population: gameState.population, energy: gameState.energy, grid: gameState.grid };
          localStorage.setItem(CITY_SAVE_KEY, JSON.stringify(snap));
        } catch (e) { }
      }, 8000);
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>